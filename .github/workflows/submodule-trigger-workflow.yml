# SPDX-FileCopyrightText: 2024 IONOS Productivity
# SPDX-License-Identifier: MIT
name: Trigger ncw-server submodule update

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  get-commit-info:
    runs-on: [self-hosted]
    outputs:
      sha: ${{ steps.commit-info.outputs.sha }}
      short_sha: ${{ steps.commit-info.outputs.short_sha }}
      message: ${{ steps.commit-info.outputs.message }}
      author: ${{ steps.commit-info.outputs.author }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get commit information
        id: commit-info
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT

  call-submodule-update:
    needs: get-commit-info
    runs-on: [self-hosted]

    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: IONOS-Productivity
          repositories: ncw-server

      - name: Trigger ncw-server submodule update workflow
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ steps.generate-token.outputs.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/IONOS-Productivity/ncw-server/dispatches \
            -d '{
              "event_type": "submodule-update",
              "client_payload": {
                "submodule_name": "IONOS",
                "submodule_repo": "${{ github.repository }}",
                "commit_sha": "${{ needs.get-commit-info.outputs.sha }}",
                "commit_message": "${{ needs.get-commit-info.outputs.message }}",
                "trigger_repo": "${{ github.repository }}",
                "trigger_ref": "${{ github.ref }}"
              }
            }'

  log-details:
    needs: [get-commit-info, call-submodule-update]
    runs-on: [self-hosted]
    if: always()

    steps:
      - name: Log trigger details
        run: |
          echo "::notice::âœ… Triggered ncw-server submodule update workflow"
          echo "::notice::ðŸ“¦ Submodule: IONOS"
          echo "::notice::ðŸ”— Commit: ${{ needs.get-commit-info.outputs.sha }}"
          echo "::notice::ðŸ’¬ Message: ${{ needs.get-commit-info.outputs.message }}"
          echo "::notice::ðŸ‘¤ Author: ${{ needs.get-commit-info.outputs.author }}"
